# æµ‹è¯•ç¯å¢ƒé…ç½®ä¸è¿è¡ŒæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨ **Pest PHP** ä½œä¸ºæµ‹è¯•æ¡†æ¶ï¼Œæµ‹è¯•ç¯å¢ƒè‡ªåŠ¨é…ç½®ä¸ºä½¿ç”¨ **SQLite å†…å­˜æ•°æ®åº“**ï¼Œæ— éœ€é¢å¤–å®‰è£…æˆ–é…ç½®æ•°æ®åº“æœåŠ¡å™¨ã€‚

## âœ… æµ‹è¯•ç¯å¢ƒç‰¹ç‚¹

1. **é›¶é…ç½®**: æµ‹è¯•ä½¿ç”¨ SQLite å†…å­˜æ•°æ®åº“ï¼ˆ`:memory:`ï¼‰ï¼Œæ— éœ€å®‰è£… MySQL/PostgreSQL
2. **è‡ªåŠ¨æ¸…ç†**: æ¯æ¬¡æµ‹è¯•è¿è¡Œåè‡ªåŠ¨æ¸…ç†æ•°æ®åº“ï¼ˆä½¿ç”¨ `RefreshDatabase` traitï¼‰
3. **éš”ç¦»æ€§**: æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹éƒ½åœ¨ç‹¬ç«‹çš„ç¯å¢ƒä¸­è¿è¡Œ
4. **å¿«é€Ÿ**: å†…å­˜æ•°æ®åº“æ‰§è¡Œé€Ÿåº¦æå¿«

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¡®ä¿ä¾èµ–å·²å®‰è£…

```bash
composer install
```

### 2. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
php artisan test

# æˆ–ä½¿ç”¨ Pest ç›´æ¥è¿è¡Œ
./vendor/bin/pest

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
php artisan test tests/Feature/AuthTest.php

# è¿è¡Œç‰¹å®šæµ‹è¯•å¥—ä»¶
php artisan test --testsuite=Feature
php artisan test --testsuite=Unit
```

### 3. æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡ï¼ˆå¯é€‰ï¼‰

```bash
# éœ€è¦å…ˆå®‰è£… pcov æˆ– xdebug
php artisan test --coverage
```

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ Pest.php                    # Pest é…ç½®æ–‡ä»¶
â”œâ”€â”€ TestCase.php                # åŸºç¡€æµ‹è¯•ç±»
â”œâ”€â”€ Feature/                    # åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ AuthTest.php           # è®¤è¯æµ‹è¯•
â”‚   â”œâ”€â”€ IdempotencyTest.php    # å¹‚ç­‰æ€§æµ‹è¯•
â”‚   â”œâ”€â”€ RateLimitTest.php      # é™æµæµ‹è¯•
â”‚   â”œâ”€â”€ AuditLogTest.php       # å®¡è®¡æ—¥å¿—æµ‹è¯•
â”‚   â””â”€â”€ KycTest.php            # KYC æµ‹è¯•
â””â”€â”€ Unit/                       # å•å…ƒæµ‹è¯•
    â””â”€â”€ ExampleTest.php
```

## âš™ï¸ æµ‹è¯•é…ç½®è¯´æ˜

### phpunit.xml é…ç½®

æµ‹è¯•ç¯å¢ƒé…ç½®åœ¨ `phpunit.xml` æ–‡ä»¶ä¸­ï¼š

- **æ•°æ®åº“**: SQLite å†…å­˜æ•°æ®åº“ï¼ˆ`:memory:`ï¼‰
- **ç¼“å­˜**: æ•°ç»„ç¼“å­˜ï¼ˆ`array`ï¼‰
- **é˜Ÿåˆ—**: åŒæ­¥é˜Ÿåˆ—ï¼ˆ`sync`ï¼‰
- **ä¼šè¯**: æ•°ç»„é©±åŠ¨ï¼ˆ`array`ï¼‰

### ç¯å¢ƒå˜é‡

æµ‹è¯•ç¯å¢ƒä¼šè‡ªåŠ¨è®¾ç½®ä»¥ä¸‹å˜é‡ï¼ˆæ— éœ€æ‰‹åŠ¨é…ç½®ï¼‰ï¼š

```xml
<env name="APP_ENV" value="testing"/>
<env name="DB_CONNECTION" value="sqlite"/>
<env name="DB_DATABASE" value=":memory:"/>
<env name="CACHE_STORE" value="array"/>
<env name="JWT_SECRET" value="..."/>
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹è¯´æ˜

### æ¨¡å— 1 æµ‹è¯•è¦†ç›–

#### âœ… AuthTest.php (8 ä¸ªæµ‹è¯•)
- ç”¨æˆ·æ³¨å†Œï¼ˆå«é‚€è¯·ç ï¼‰
- ç”¨æˆ·ç™»å½•
- ä»¤ç‰Œåˆ·æ–°
- ç”¨æˆ·ä¿¡æ¯è·å–

#### âœ… IdempotencyTest.php (4 ä¸ªæµ‹è¯•)
- å¹‚ç­‰æ€§å¯†é’¥éªŒè¯
- é‡å¤è¯·æ±‚ç¼“å­˜
- GET è¯·æ±‚è±å…

#### âœ… RateLimitTest.php (4 ä¸ªæµ‹è¯•)
- é™æµé€»è¾‘
- é™æµå¤´ä¿¡æ¯
- ç”¨æˆ·ç‹¬ç«‹é™æµ

#### âœ… AuditLogTest.php (5 ä¸ªæµ‹è¯•)
- å®¡è®¡æ—¥å¿—è®°å½•
- æŸ¥è¯¢åŠŸèƒ½
- JSON å­˜å‚¨

#### âœ… KycTest.php (5 ä¸ªæµ‹è¯•)
- KYC æäº¤
- å®¡æ ¸æµç¨‹
- å¼‚å¸¸å¤„ç†

## ğŸ” éªŒè¯æµ‹è¯•è¿è¡Œ

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
php artisan test
```

é¢„æœŸè¾“å‡ºï¼š
```
PASS  Tests\Feature\AuthTest
PASS  Tests\Feature\IdempotencyTest
PASS  Tests\Feature\RateLimitTest
PASS  Tests\Feature\AuditLogTest
PASS  Tests\Feature\KycTest

Tests:  XX passed
Duration: X.XXs
```

### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# æµ‹è¯•è®¤è¯åŠŸèƒ½
php artisan test tests/Feature/AuthTest.php

# æµ‹è¯•å¹‚ç­‰æ€§
php artisan test tests/Feature/IdempotencyTest.php
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. JWT Secret é”™è¯¯

**é”™è¯¯**: `SecretMissingException`

**è§£å†³**: å·²åœ¨ `phpunit.xml` ä¸­é…ç½® `JWT_SECRET`ï¼Œå¦‚æœä»æœ‰é—®é¢˜ï¼Œè¿è¡Œï¼š
```bash
php artisan jwt:secret --force
```

### 2. æ•°æ®åº“è¿ç§»é”™è¯¯

**é”™è¯¯**: `SQLSTATE[HY000]: General error: 1 no such table`

**è§£å†³**: æµ‹è¯•ä¼šè‡ªåŠ¨è¿è¡Œè¿ç§»ï¼Œå¦‚æœé‡åˆ°é—®é¢˜ï¼Œæ£€æŸ¥è¿ç§»æ–‡ä»¶æ˜¯å¦æ­£ç¡®ã€‚

### 3. æµ‹è¯•è¶…æ—¶

**è§£å†³**: æŸäº›æµ‹è¯•ï¼ˆå¦‚é™æµæµ‹è¯•ï¼‰å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå¯ä»¥è°ƒæ•´ `phpunit.xml` ä¸­çš„ `timeout` è®¾ç½®ã€‚

## ğŸ“Š æµ‹è¯•æœ€ä½³å®è·µ

1. **æ¯æ¬¡æäº¤å‰è¿è¡Œæµ‹è¯•**
   ```bash
   php artisan test
   ```

2. **ç¼–å†™æ–°åŠŸèƒ½æ—¶å…ˆå†™æµ‹è¯•**
   - éµå¾ª TDDï¼ˆæµ‹è¯•é©±åŠ¨å¼€å‘ï¼‰åŸåˆ™

3. **ä¿æŒæµ‹è¯•ç‹¬ç«‹**
   - æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œ
   - ä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„æ‰§è¡Œé¡ºåº

4. **ä½¿ç”¨æœ‰æ„ä¹‰çš„æµ‹è¯•åç§°**
   - æµ‹è¯•åç§°åº”è¯¥æ¸…æ¥šæè¿°æµ‹è¯•å†…å®¹

## ğŸ”„ CI/CD é›†æˆ

æµ‹è¯•å¯ä»¥åœ¨ CI/CD æµç¨‹ä¸­è‡ªåŠ¨è¿è¡Œï¼š

```yaml
# GitHub Actions ç¤ºä¾‹
- name: Run Tests
  run: |
    composer install
    php artisan test
```

## ğŸ“ ä¸‹ä¸€æ­¥

å®Œæˆæµ‹è¯•ç¯å¢ƒé…ç½®åï¼Œå¯ä»¥ï¼š

1. âœ… è¿è¡Œç°æœ‰æµ‹è¯•éªŒè¯ç¯å¢ƒ
2. âœ… å¼€å§‹å®ç°æ¨¡å— 2ï¼ˆAccounts & Ledgerï¼‰
3. âœ… ä¸ºæ–°æ¨¡å—æ·»åŠ æµ‹è¯•ç”¨ä¾‹

---

**æ³¨æ„**: æµ‹è¯•ç¯å¢ƒå®Œå…¨ç‹¬ç«‹äºå¼€å‘ç¯å¢ƒï¼Œä¸ä¼šå½±å“å¼€å‘æ•°æ®åº“æˆ–é…ç½®ã€‚

